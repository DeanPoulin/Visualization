!function(t,a){"function"==typeof define&&define.amd?define(["d3","../layout/Grid","./HipieDDL","../layout/Surface","../layout/Cell","../layout/Popup","../other/Persist","./FlyoutButton"],a):t.marshaller_HTML=a(t.d3,t.layout_Grid,t.marshaller_HipieDDL,t.layout_Surface,t.layout_Cell,t.layout_Popup,t.other_Persist,t.marshaller_FlyoutButton)}(this,function(t,a,e,r,i,o,n,s){function l(){a.call(this),this.surfacePadding(0)}function p(t,a){a instanceof Object||a&&(a=JSON.parse(a));var r=null,i={};return t.accept({visit:function(t){t instanceof e.Dashboard?(r={dashboard:t,visualizations:[]},i[t.getQualifiedID()]=r):t instanceof e.DataSource?t.databomb&&a[t.id]&&t.comms.databomb(a[t.id]):t instanceof e.Output?t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from):t instanceof e.Visualization&&t.widget&&r.visualizations.push(t)}}),i}return l.prototype=Object.create(a.prototype),l.prototype.constructor=l,l.prototype._class+=" marshaller_HTML",l.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),l.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),l.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),l.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),l.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),l.prototype.enter=function(t,e){a.prototype.enter.apply(this,arguments),this.popupContainer=e.append("div").classed("popup-container",!0).style({height:"100px",position:"absolute","z-index":1e3})},l.prototype.render=function(i){function o(){var t=p(c.marshaller,c.databomb());for(var e in t){var o=[],n=[];t[e].visualizations.forEach(function(t,a){u.remove(t.id),t.properties.flyout?o.push(t):n.push(t)}),u.forEach(function(t,a){c.clearContent(a)});var l=0,d=0,h=c.cellDensity(),f=Math.floor(Math.sqrt(n.length));n.forEach(function(t,a){if(!c.marshaller.widgetMappings().get(t.id)){var e=null;for(e=t.widget instanceof r||"composite_MegaChart"===t.widget.classID()?t.widget:(new r).widget(t.widget),t.widget.size({width:0,height:0}),e.title(t.title);null!==c.getCell(l*h,d*h);)d++,d%f===0&&(l++,d=0);c.setContent(l,d,e)}}),o.forEach(function(t,a){var e=t.events.getUpdatesVisualizations();e.forEach(function(a){switch(a.widget.classID()){case"composite_MegaChart":var e=(new s).title(t.title).widget(t.widget);a.widget.toolbarWidgets().push(e)}})})}var g={};c.content().forEach(function(t){var a=t.widget();a&&"layout_Surface"===a.classID()&&(a=a.widget()),a&&(g[a.id()]=t)});for(e in t)t[e].visualizations.forEach(function(t,a){if(!t.properties.flyout){var e=t.events.getUpdatesVisualizations(),r=e.map(function(t){return g[t.id].id()});g[t.id].indicateTheseIds(r)}});a.prototype.render.call(c,function(a){for(var e in t)for(var r in t[e].dashboard.datasources)t[e].dashboard.datasources[r].fetchData({},!0);var o=0,n=setInterval(function(){(c.marshaller.commsDataLoaded()||++o>120)&&(clearInterval(n),i&&i(a))},500)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this.marshaller&&this.marshaller.proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()),a.prototype.render.apply(this,arguments);this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var l=[];n.widgetArrayWalker(this.content(),function(t){l.push(t)});var d=t.map(l,function(t){return t.id()}),u=t.map(l.filter(function(t){return 0!==t.id().indexOf(t._idSeed)&&0!==t.id().indexOf("_pe")}),function(t){return t.id()}),c=this;return this.marshaller=(new e.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).widgetMappings(d).on("commsError",function(t,a){c.commsError(t,a)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this.marshaller.parse(this.ddlUrl(),function(){o()}):this.marshaller.url(this.ddlUrl(),function(){o()}),this},l.prototype.commsError=function(t,a){alert("Comms Error:\n"+t+"\n"+a)},l});