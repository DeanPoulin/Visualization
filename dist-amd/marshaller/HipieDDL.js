(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/Database","../common/Utility","../other/Comms","../common/Widget","require"],t):e.marshaller_HipieDDL=t(e.d3,e.common_Database,e.common_Utility,e.other_Comms,e.common_Widget,e.require)})(this,function(e,t,n,r,i,s){function f(e,t){this.visualization=e;var n={};for(var r in t)t[r]instanceof Array?t[r].forEach(function(e,t){n[t===0?r:r+"_"+t]=e}):n[r]=t[r];this.mappings=n,this.hasMappings=!1,this.reverseMappings={},this.columns=[],this.columnsIdx={},this.columnsRHS=[],this.columnsRHSIdx={}}function l(e,t){f.call(this,e,t),this.columns=["label","weight"],this.columnsIdx={label:0,weight:1},this.init()}function c(e,t){f.call(this,e,t),t.state?(this.columns=["state","weight"],this.columnsIdx={state:0,weight:1}):t.county&&(this.columns=["county","weight"],this.columnsIdx={county:0,weight:1}),this.init()}function h(e,t){f.call(this,e,t),t.state?(this.columns=["state"],this.columnsIdx={state:0}):t.county&&(this.columns=["county"],this.columnsIdx={county:0}),t.weight.forEach(function(e,t){this.columns.push(e),this.columnsIdx[t===0?"weight":"weight_"+t]=t+1},this),this.init()}function p(e,t){f.call(this,e,t),this.columns=["x","y","weight"],this.columnsIdx={x:0,y:1,weight:2},this.init()}function d(e,t){var n={label:t.x[0]};t.y.forEach(function(e,t){n[e]=e}),f.call(this,e,n),this.init()}function v(e,t){var n={};for(var r in t)t[r].forEach(function(t,r){n[e.label[r]]=t});f.call(this,e,n),this.init()}function m(e,t,n){f.call(this,e,t),this.icon=e.icon||{},this.fields=e.fields||{},this.columns=["uid","label","weight","flags"],this.columnsIdx={uid:0,label:1,weight:2,flags:3},this.init(),this.link=n}function g(e,t){this.visualization=e;if(t){this._id=t.id,this._output=t.output,this.mappings=null,t.mappings||console.log("no mappings for:"+e.id+"->"+t.id);switch(this.visualization.type){case"LINE":this.mappings=new d(this.visualization,t.mappings);break;case"TABLE":this.mappings=new v(this.visualization,t.mappings);break;case"GRAPH":this.mappings=new m(this.visualization,t.mappings,t.link);break;case"CHORO":t.mappings.weight instanceof Array&&t.mappings.weight.length?(this.mappings=new h(this.visualization,t.mappings,t.link),t.mappings.weight.length>1&&(this.visualization.type="LINE")):this.mappings=new c(this.visualization,t.mappings,t.link);break;case"HEAT_MAP":this.mappings=new p(this.visualization,t.mappings,t.link);break;default:this.mappings=new l(this.visualization,t.mappings)}this.first=t.first,this.reverse=t.reverse,this.sort=t.sort}}function y(e,t,n){this.visualization=e,this.eventID=t,n&&(this._updates=n.updates,this.mappings=n.mappings)}function b(e,t){this.visualization=e,this.events={};for(var n in t)this.events[n]=new y(e,n,t[n])}function w(e,t){this.dashboard=e,this.id=t.id,this.label=t.label,this.title=t.title||t.id,this.type=t.type,this.icon=t.icon||{},this.fields=t.fields||{},this.properties=t.properties||(t.source?t.source.properties:null)||{},this.source=new g(this,t.source),this.events=new b(this,t.events);if(this.dashboard.marshaller._widgetMappings.has(t.id))this.setWidget(this.dashboard.marshaller._widgetMappings.get(t.id),!0);else{var n=this;switch(this.type){case"CHORO":this.loadWidget(this.source.mappings.contains("county")?"src/map/ChoroplethCounties":"src/map/ChoroplethStates",function(e){e.id(t.id).paletteID(t.color)});break;case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":this.loadWidget("src/chart/MultiChart",function(e){e.id(t.id).chartType(n.properties.chartType||n.properties.charttype||n.type)});break;case"LINE":this.loadWidget("src/chart/MultiChart",function(e){e.id(t.id).showLegend(!0).domainAxisTitle(n.source.getXTitle()).valueAxisTitle(n.source.getYTitle()).chartType(n.properties.chartType||n.properties.charttype||n.type)});break;case"TABLE":this.loadWidget("src/other/Table",function(e){e.id(t.id).columns(n.label)});break;case"SLIDER":this.loadWidget("src/form/Slider",function(e){e.id(t.id);if(t.range){var n="";for(var r in t.events.events.mappings){n=r;break}e.low(+t.range[0]).high(+t.range[1]).step(+t.range[2]).selectionLabel(n)}});break;case"GRAPH":this.loadWidgets(["src/graph/Graph","src/graph/Vertex","src/graph/Edge"],function(e,n){o=n[1],u=n[2],e.id(t.id).layout("ForceDirected2").applyScaleOnLayout(!0)});break;case"FORM":this.loadWidgets(["src/form/Form","src/form/Input"],function(e,n){var r=n[1];e.id(t.id).inputs(t.fields.map(function(e){var t=null,n=[],i=[];switch(e.properties.charttype){case"TEXT":t="textbox";break;case"TEXTAREA":t="textarea";break;case"CHECKBOX":t="checkbox";break;case"RADIO":t="radio";break;case"HIDDEN":t="hidden";break;default:if(e.properties.enumvals){t="select",i=e.properties.enumvals;for(var s in i)n.push([s,i[s]])}else t="textbox"}var o=(new r).name(e.id).label((e.properties?e.properties.label:null)||e.label).type(t).value(e.properties.default?e.properties.default:"");if(t==="checkbox"||t==="radio"){var u=Object.keys(e.properties.enumvals);o.selectOptions(u)}else n.length&&o.selectOptions(n);return o}))});break;case"HEAT_MAP":this.loadWidgets(["src/other/HeatMap"],function(e,r){e.id(t.id).image(n.properties.imageUrl)});break;default:this.loadWidget("src/common/TextBox",function(e){e.id(t.id).text(n.id+"\n"+"TODO:  "+n.type)})}}}function E(e,t){this.dataSource=e,this.id=t.id,this.from=t.from,this.request={},this.notify=t.notify||[],this.filter=t.filter||[]}function S(e,t,n){this.dashboard=e,this.id=t.id,this.filter=t.filter||[],this.WUID=t.WUID,this.URL=t.URL,this.databomb=t.databomb,this.request={},this._loadedCount=0;var i=this;this.outputs={};var s=[];t.outputs.forEach(function(e){i.outputs[e.id]=new E(i,e),s.push({id:e.id,from:e.from,filter:e.filter||this.filter})},this),this.WUID?this.comms=(new r.HIPIEWorkunit).url(e.marshaller.espUrl._url).proxyMappings(n).hipieResults(s):this.databomb?this.comms=(new r.HIPIEDatabomb).hipieResults(s):this.comms=(new r.HIPIERoxie).url(t.URL).proxyMappings(n)}function x(e,t,n){this.marshaller=e,this.id=t.id,this.title=t.title;var r=this;this.datasources={},this.datasourceTotal=0,t.datasources.forEach(function(e){r.datasources[e.id]=new S(r,e,n),++r.datasourceTotal}),this._visualizations={},this._visualizationArray=[],t.visualizations.forEach(function(e){var t=new w(this,e);this._visualizations[e.id]=t,this._visualizationArray.push(t),this.marshaller._visualizations[e.id]=t,this.marshaller._visualizationArray.push(t)},this),this._visualizationTotal=this._visualizationArray.length}function T(){this._proxyMappings={},this._widgetMappings=e.map()}var o=null,u=null,a=function(e,t){var n=e.split("."),r=t;for(var i=0;i<n.length;++i){var s=n[i];if(!r||r[s]===undefined)return!1;r=r[s]}return!0};return f.prototype.init=function(){for(var e in this.mappings)this.reverseMappings[this.mappings[e]]=e,this.columnsIdx[e]===undefined&&(this.columns.push(e),this.columnsIdx[e]=this.columns.length-1),this.columnsRHS[this.columnsIdx[e]]=this.mappings[e],this.columnsRHSIdx[this.mappings[e]]=this.columnsIdx[e],this.hasMappings=!0},f.prototype.contains=function(e){return this.mappings[e]!==undefined},f.prototype.doMap=function(e){var t=[];for(var n in this.mappings){var r=this.mappings[n];try{var i=e[r];i===undefined&&(i=e[r.toLowerCase()]);if(i===undefined&&r.indexOf("_AVE")===r.length-4&&e.base_count!==undefined){var s=r.substring(0,r.length-4)+"_SUM";i=e[s],i===undefined&&(i=e[s.toLowerCase()]),i&&(i/=e.base_count)}t[this.columnsIdx[n]]=i}catch(o){console.log("Invalid Mapping:  "+this.visualization.id+" ["+r+"->"+e+"]")}}return t},f.prototype.doMapAll=function(e){return e.hipieMappings(this.columnsRHS)},f.prototype.getMap=function(e){return this.mappings[e]},f.prototype.getReverseMap=function(e){return this.reverseMappings[e]},l.prototype=Object.create(f.prototype),c.prototype=Object.create(f.prototype),h.prototype=Object.create(f.prototype),p.prototype=Object.create(f.prototype),d.prototype=Object.create(f.prototype),v.prototype=Object.create(f.prototype),m.prototype=Object.create(f.prototype),m.prototype.calcAnnotation=function(e,t,n){function i(e){return e?String.fromCharCode(parseInt(e)):e}function s(e,t){if(e)for(var r in e)switch(r){case"faChar":t.faChar=i(e.faChar);break;case"tooltip":t[r]=e[r];break;case"icon_image_colorFill":case"icon_shape_colorFill":case"icon_shape_colorStroke":n?t[r.split("icon_")[1]]=e[r]:t[r]=e[r];break;case"textbox_image_colorFill":case"textbox_shape_colorFill":case"textbox_shape_colorStroke":n||(t[r]=e[r]);break;case"id":case"valuemappings":case"font":case"charttype":break;default:console.log("Unknown annotation property:  "+r)}}var r={};s(e,r);if(t&&t[e.id]&&e.valuemappings){var o=e.valuemappings[t[e.id]];s(o,r)}for(var u in r)return r;return null},m.prototype.doMapAll=function(e){function s(e,t){var s="uid_"+e[0],u=r[s];u||(u=(new o).faChar("ï„¨").text(e[1]),u.__hpcc_uid=e[0],r[s]=u,i.push(u));if(t){var a=n.calcAnnotation(n.visualization.icon,t);if(a)for(var f in a)u[f]&&u[f](a[f]);var l=[];n.fields.forEach(function(e){var r=n.calcAnnotation(e,t,!0);r&&l.push(r)}),u.annotationIcons(l)}return u}var t=e.jsonObj(),n=this,r={},i=[],a=[];return t.forEach(function(e){var t=n.doMap(e),r=s(t,e);if(e[n.link.childfile]&&e[n.link.childfile].Row){var i=e[n.link.childfile].Row;i.forEach(function(e,t){var i=n.doMap(e),o=s(i);if(r.id()!==o.id()){var f=(new u).sourceVertex(r).targetVertex(o).sourceMarker("circleFoot").targetMarker("arrowHead");a.push(f)}})}}),{vertices:i,edges:a,merge:!1}},g.prototype.getQualifiedID=function(){return this.visualization.getQualifiedID()+"."+this.id},g.prototype.exists=function(){return this._id},g.prototype.getDatasource=function(){return this.visualization.dashboard.datasources[this._id]},g.prototype.getOutput=function(){var e=this.getDatasource();return e&&e.outputs?e.outputs[this._output]:null},g.prototype.hasData=function(){return this.getOutput().db?!0:!1},g.prototype.getColumns=function(){return this.mappings.columns},g.prototype.getData=function(){var e=this.getOutput().db,t=this.mappings.doMapAll(e);return this.sort&&n.multiSort(t,e.hipieMapSortArray(this.sort)),this.reverse&&t.reverse(),this.first&&t.length>this.first&&(t.length=this.first),t},g.prototype.getXTitle=function(){return this.mappings.columns[0]},g.prototype.getYTitle=function(){return this.mappings.columns.filter(function(e,t){return t>0}).join(" / ")},y.prototype.exists=function(){return this._updates!==undefined},y.prototype.getUpdates=function(){var e=[];return a("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(t,n){var r=this.visualization.dashboard.datasources[t.datasource],i=this.visualization.dashboard.getVisualization(t.visualization);e.push({eventID:this.eventID,datasource:r,visualization:i})},this),e},y.prototype.getUpdatesDatasources=function(){var e={},t=[];return this.getUpdatesVisualizations().forEach(function(n,r){var i=n.source.getDatasource();i&&!e[i.id]&&(e[i.id]=!0,t.push(i))},this),t},y.prototype.getUpdatesVisualizations=function(){var e={},t=[];return a("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(n,r){var i=this.visualization.dashboard.getVisualization(n.visualization);e[i.id]||(e[i.id]=!0,t.push(i))},this),t},b.prototype.setWidget=function(e){var t=this;for(var n in this.events)e["vertex_"+n]?e["vertex_"+n]=function(e){t.visualization.onEvent(n,t.events[n],e)}:e[n]&&(e[n]=function(e,r,i){t.visualization.onEvent(n,t.events[n],e,r,i)})},b.prototype.exists=function(){return this._updates!==undefined},b.prototype.getUpdates=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdates());return e},b.prototype.getUpdatesDatasources=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdatesDatasources());return e},b.prototype.getUpdatesVisualizations=function(){var e=[];for(var t in this.events)e=e.concat(this.events[t].getUpdatesVisualizations());return e},w.prototype.getQualifiedID=function(){return this.id},w.prototype.isLoading=function(e,t){return this.widget===null},w.prototype.isLoaded=function(e,t){return this.widget instanceof i},w.prototype.loadWidget=function(e,t){this.loadWidgets([e],t)},w.prototype.loadWidgets=function(e,t){this.widget=null;var n=this;s(e,function(e){n.setWidget(new e),t&&t(n.widget,arguments)})},w.prototype.setWidget=function(e,t){this.widget=e,this.events.setWidget(e);if(!t)if(e.classID()==="chart_MultiChart")e.chartTypeProperties(this.properties);else for(var n in this.properties)if(this.widget[n])try{this.widget[n](this.properties[n])}catch(r){console.log("Invalid Property:"+this.id+".properties."+n)}return this.widget},w.prototype.accept=function(e){e.visit(this)},w.prototype.update=function(){var e=this.source.getOutput().getParams();a("widgetSurface.title",this)?(this.widgetSurface.title(this.title+(e?" ("+e+")":"")),this.widgetSurface.render()):this.widget.render()},w.prototype.notify=function(){if(this.source.hasData()&&this.widget){var e=this.source.getColumns();this.widget.columns(e);var t=this.source.getData();this.widget.data(t),this.update()}},w.prototype.clear=function(){this.widget&&(this.widget.data([]),this.source.getOutput().request={}),this._eventValues&&(delete this._eventValues,this.events.getUpdatesVisualizations().forEach(function(e){e.clear()})),this.update()},w.prototype.onEvent=function(e,t,n,r,i){var s=this;setTimeout(function(){i=i===undefined?!0:i;if(t.exists()){var e={};for(var r in t.mappings){var o=s.source.mappings&&s.source.mappings.hasMappings?s.source.mappings.getReverseMap(r):r;e[t.mappings[r]]=i?n[o]:""}s._eventValues=e;var u={},a=t.getUpdatesVisualizations();a.forEach(function(e){var t=e.source.getDatasource();u[t.id]||(u[t.id]={datasource:t,request:{},updates:[]}),u[t.id].updates.push(e.id),e.getInputVisualizations().forEach(function(e,n){if(e._eventValues)for(var r in e._eventValues)u[t.id].request[r]&&u[t.id].request[r]!==e._eventValues[r]&&console.log("Duplicate Filter, with mismatched value:  "+r+"="+e._eventValues[r]),u[t.id].request[r]=e._eventValues[r],u[t.id].request[r+"_changed"]=e===s}),e.clear(),(t.WUID||t.databomb)&&t.fetchData(u[t.id].request,!1,[e.id])});for(var f in u)!u[f].datasource.WUID&&!u[f].datasource.databomb&&u[f].datasource.fetchData(u[f].request,!1,u[f].updates)}},0)},w.prototype.getInputVisualizations=function(){return this.dashboard.marshaller.getVisualizationArray().filter(function(e){var t=e.events.getUpdatesVisualizations();return t.indexOf(this)>=0?!0:!1},this)},E.prototype.getQualifiedID=function(){return this.dataSource.getQualifiedID()+"."+this.id},E.prototype.getParams=function(){var e="";for(var t in this.request)n.endsWith(t,"_changed")||(e.length&&(e+=", "),e+=this.request[t]);return e},E.prototype.accept=function(e){e.visit(this)},E.prototype.setData=function(e,n,r){var i=this;this.request=n,this.db=(new t.Grid).jsonObj(e),this.notify.forEach(function(e){if(!r||r.indexOf(e)>=0){var t=i.dataSource.dashboard.getVisualization(e);t.notify()}})},S.prototype.getQualifiedID=function(){return this.dashboard.getQualifiedID()+"."+this.id},S.prototype.accept=function(e){e.visit(this);for(var t in this.outputs)this.outputs[t].accept(e)},S.prototype.fetchData=function(e,t,n){if(!n){n=[];for(var r in this.outputs){var i=this.outputs[r];(!i.filter||!i.filter.length)&&i.notify.forEach(function(e){n.push(e)})}}var s=this;this.request.refresh=t?!0:!1,this.filter.forEach(function(t){this.request[t+"_changed"]=e[t+"_changed"]||!1;var n=e[t]===undefined?"":e[t];this.request[t]!==n&&(this.request[t]=n)},this),window.__hpcc_debug&&console.log("fetchData:  "+JSON.stringify(n)+"("+JSON.stringify(e)+")"),this.comms.call(this.request,function(t){s.processResponse(t,e,n),++s._loadedCount})},S.prototype.processResponse=function(e,t,n){var r={};for(var i in e)r[i.toLowerCase()]=e[i];for(var s in this.outputs){var o=this.outputs[s].from;o||(o=this.outputs[s].id.toLowerCase());if(a(o,e))(!a(o+"_changed",e)||a(o+"_changed",e)&&e[o+"_changed"].length&&e[o+"_changed"][0][o+"_changed"])&&this.outputs[s].setData(e[o],t,n);else if(a(o,r))console.log("DDL 'DataSource.From' case is Incorrect"),(!a(o+"_changed",r)||a(o+"_changed",r)&&e[o+"_changed"].length&&r[o+"_changed"][0][o+"_changed"])&&this.outputs[s].setData(r[o],t,n);else{var u=[];for(var f in e)u.push(f);console.log("Unable to locate '"+o+"' in response {"+u.join(", ")+"}")}}},x.prototype.getQualifiedID=function(){return this.id},x.prototype.getVisualization=function(e){return this._visualizations[e]||this.marshaller.getVisualization(e)},x.prototype.getVisualizations=function(){return this._visualizations},x.prototype.getVisualizationArray=function(){return this._visualizationArray},x.prototype.getVisualizationTotal=function(){return this._visualizationTotal},x.prototype.accept=function(e){e.visit(this);for(var t in this.datasources)this.datasources[t].accept(e);this._visualizationArray.forEach(function(t){t.accept(e)},this)},x.prototype.allVisualizationsLoaded=function(){var e=this._visualizationArray.filter(function(e){return!e.isLoaded()});return e.length===0},T.prototype.commsDataLoaded=function(){for(var e=0;e<this.dashboardArray.length;e++)for(var t in this.dashboardArray[e].datasources)if(this.dashboardArray[e].datasources[t]._loadedCount===0)return!1;return!0},T.prototype.getVisualization=function(e){return this._visualizations[e]},T.prototype.accept=function(e){e.visit(this),this.dashboardTotal=0;for(var t in this.dashboards)this.dashboards[t].accept(e),++this.dashboardTotal},T.prototype.url=function(e,t){this.espUrl=(new r.ESPUrl).url(e);var n=null,i="HIPIE_DDL";this.espUrl.isWorkunitResult()?(i=this.espUrl._params.ResultName,n=(new r.HIPIEWorkunit).url(e).proxyMappings(this._proxyMappings)):n=(new r.HIPIERoxie).url(e).proxyMappings(this._proxyMappings);var s={refresh:!1},o=this;n.call(s,function(r){a(i,r)&&n.fetchResult(i,function(n){var s=n[0][i],u=s.split("<RoxieBase>\\");if(u.length>1){var a=u[1].indexOf('"');u[1]=u[1].substring(a),s=u.join(e)}o.parse(s,function(){t(r)})})})},T.prototype.proxyMappings=function(e){return arguments.length?(this._proxyMappings=e,this):this._proxyMappings},T.prototype.widgetMappings=function(e){return arguments.length?(this._widgetMappings=e,this):this._widgetMappings},T.prototype.parse=function(e,t){var n=this;return this._json=e,this._jsonParsed=JSON.parse(this._json),this.dashboards={},this.dashboardArray=[],this._visualizations={},this._visualizationArray=[],this._jsonParsed.forEach(function(e){var t=new x(n,e,n._proxyMappings);n.dashboards[e.id]=t,n.dashboardArray.push(t)}),this.dashboardTotal=this.dashboardArray.length,this.ready(t),this},T.prototype.getVisualizations=function(){return this._visualizations},T.prototype.getVisualizationArray=function(){return this._visualizationArray},T.prototype.allDashboardsLoaded=function(){return this.dashboardArray.filter(function(e){return!e.allVisualizationsLoaded()}).length===0},T.prototype.ready=function(e){function n(e){t.allDashboardsLoaded()?e():setTimeout(n,100,e)}if(!e)return;var t=this;n(e)},{exists:a,Marshaller:T,Dashboard:x,DataSource:S,Output:E,Visualization:w}});