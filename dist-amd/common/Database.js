(function(e,t){typeof define=="function"&&define.amd?define(["d3"],t):e.common_Database=t(e.d3)})(this,function(e){function t(){this.clear()}function n(e,t){return e instanceof Array||(e=[e]),e.filter(function(e){return e!==""}).every(t)}function r(e){return typeof e=="boolean"}function i(e){return typeof e=="number"||!isNaN(e)}function s(e){return typeof e=="string"}function l(t,n){for(var r=0;r<t.length;++r){var i=e.time.format(t[r]).parse(n);if(i)return f=t[r],t[r]}return null}function c(e){return l(o,e)}function h(e){return l(u,e)}function p(e){return l(a,e)}function d(e){return["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","AS","DC","FM","GU","MH","MP","PW","PR","VI"].indexOf(String(e).toUpperCase())>=0}t.prototype.constructor=t,t.prototype.clear=function(){return this._fields=[],this._data=[],this},t.prototype.legacyColumns=function(e){return arguments.length?(this.row(0,e),this):this.row(0)},t.prototype.legacyData=function(e,n){return t.prototype.data.apply(this,arguments)},t.prototype.fields=function(e,t){return arguments.length?(this._fields=t?e.map(function(e){return e}):e,this):this._fields},t.prototype.fieldByLabel=function(e,t){return this.fields().filter(function(n,r){return n.idx=r,t?n.label.toLowerCase()===e.toLowerCase():n.label===e})[0]},t.prototype.data=function(e,t){return arguments.length?(this._data=t?e.map(function(e){return e.map(function(e){return e})}):e,this):this._data},t.prototype.row=function(e,t){return arguments.length<2?e===0?this._fields.map(function(e){return e.label}):this._data[e-1]:(e===0?this._fields=t.map(function(e){return{label:e}}):this._data[e-1]=t,this)},t.prototype.rows=function(e){return arguments.length?(this.row(0,e[0]),this._data=e.filter(function(e,t){return t>0}),this):[this.row(0)].concat(this._data)},t.prototype.column=function(e,t){return arguments.length<2?[this._fields[e].label].concat(this._data.map(function(t,n){return t[e]})):(t.forEach(function(n,r){r===0?this._fields[e]={label:t[0]}:this._data[r-1][e]=n},this),this)},t.prototype.columnData=function(e,t){return arguments.length<2?this._data.map(function(t,n){return t[e]}):(t.forEach(function(t,n){this._data[n][e]=t},this),this)},t.prototype.columns=function(e){return arguments.length?(e.forEach(function(t,n){this.column(n,e[n])},this),this):this._fields.map(function(e,t){return this.column(t)},this)},t.prototype.cell=function(e,t,n){return arguments.length<3?this.row(e)[t]:(e===0?this._fields[t]={label:n}:this._data[e][t]=n,this)},t.prototype.grid=function(e){return t.prototype.rows.apply(this,arguments)},t.prototype.hipieFieldsByMappings=function(e){return e.map(function(e){return this.fieldByLabel(e,!0)},this)},t.prototype.hipieFieldIdxByMappings=function(e){return this.hipieFieldsByMappings(e).map(function(e){return e.idx})},t.prototype.hipieMapSortArray=function(e){return e.map(function(e){var t=!1;return e.indexOf("-")===0&&(e=e.substring(1),t=!0),{idx:this.fieldByLabel(e,!0).idx,reverse:t}},this)},t.prototype.hipieMappings=function(t){function u(e,t,n,r){var i=n.map(function(e){return e});i[t]=e.key,e.values instanceof Array?e.values.forEach(function(e){u(e,t+1,i,r)}):(i[t+1]=e.values,r.push(i))}var n=-1,r=[],i=[],s=-1,o=[];t.forEach(function(e,t){if(e instanceof Object)switch(e.function){case"SUM":case"AVE":case"MIN":case"MAX":n>=0&&console.log("Rollup field already exists - there should only be one?"),n=t,e.params.forEach(function(e){r.push(this.fieldByLabel(e.param1,!0).idx)},this);break;case"SCALE":s>=0&&console.log("Scale field already exists - there should only be one?"),s=t,e.params.forEach(function(e){var t=this.fieldByLabel(e.param1,!0).idx,n=e.param2;o.push(function(e){return e[t]/n})},this);break;default:console.log("Unknown field function - "+e.function)}else{try{i.push(this.fieldByLabel(e,!0).idx)}catch(u){}try{var a=this.fieldByLabel(e,!0).idx;o.push(function(e){return e[a]})}catch(u){}}},this);if(n>=0){var a=t[n],f=[];for(var l in a.params)f.push(a.params[l]);var c=this.rollup(i,function(t){switch(a.function){case"SUM":return e.sum(t,function(e){return e[r[0]]});case"AVE":return e.mean(t,function(e){return e[r[0]]});case"MIN":return e.min(t,function(e){return e[r[0]]});case"MAX":return e.max(t,function(e){return e[r[0]]})}return console.log("Unsupported Mapping Function:  "+a.function),0}),h=[];return c instanceof Array?c.forEach(function(e){u(e,0,[],h)}):h.push([c]),h}return this._data.map(function(e){var t=[];return o.forEach(function(n){t.push(n(e))}),t})},t.prototype._nest=function(t,n){t instanceof Array||(t=[t]);var r=e.nest();return t.forEach(function(e){r.key(function(t){return t[e]})}),r},t.prototype.nest=function(e){return this._nest(e).entries(this._data)},t.prototype.rollup=function(e,t){return this._nest(e).rollup(t).entries(this._data)},t.prototype.length=function(){return this._data.length+1},t.prototype.width=function(){return this._fields.length},t.prototype.pivot=function(){return this.rows(this.columns()),this},t.prototype.clone=function(e){return(new t).fields(this.fields(),e).data(this.data(),e)},t.prototype.filter=function(e){var n={};return this.row(0).forEach(function(e,t){n[e]=t}),(new t).fields(this.fields(),!0).data(this.data().filter(function(t){for(var r in e)if(e[r]!==t[n[r]])return!1;return!0}))},t.prototype.analyse=function(e){e instanceof Array||(e=[e]);var t=[];return e.forEach(function(e){var o=this.rollup(e,function(e){return e.length});t.push(o);var u=o.map(function(e){return e.key});this._fields[e].isBoolean=n(u,r),this._fields[e].isNumber=n(u,i),this._fields[e].isString=!this._fields[e].isNumber&&n(u,s),this._fields[e].isUSState=this._fields[e].isString&&n(u,d),this._fields[e].isDateTime=this._fields[e].isString&&n(u,c),this._fields[e].isDateTimeFormat=f,this._fields[e].isDate=!this._fields[e].isDateTime&&n(u,h),this._fields[e].isDateFormat=f,this._fields[e].isTime=this._fields[e].isString&&!this._fields[e].isDateTime&&!this._fields[e].isDate&&n(u,p),this._fields[e].isTimeFormat=f},this),t},t.prototype.jsonObj=function(e){return arguments.length?(this.clear(),this.data(e.map(function(e,t){var n=[];for(var r in e){var i=this.row(0).indexOf(r);i<0&&(i=this._fields.length,this._fields.push({label:r})),n[i]=e[r]}return n},this)),this):this._data.map(function(e){var t={};return this.row(0).forEach(function(n,r){t[n]=e[r]}),t},this)},t.prototype.json=function(e){return arguments.length?(this.jsonObj(JSON.parse(e)),this):JSON.stringify(this.jsonObj(),null,"  ")},t.prototype.csv=function(t){return arguments.length?(this.jsonObj(e.csv.parse(t)),this):e.csv.formatRows(this.grid())},t.prototype.tsv=function(t){return arguments.length?(this.jsonObj(e.tsv.parse(t)),this):e.tsv.formatRows(this.grid())};var o=[],u=["%Y-%m-%d","%Y%m%d"],a=["%H:%M:%S.%LZ","%H:%M:%SZ","%H:%M:%S"];u.forEach(function(e){a.forEach(function(t){o.push(e+"T"+t)})});var f=null;return{Grid:t}});