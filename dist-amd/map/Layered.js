!function(t,e){"function"==typeof define&&define.amd?define(["d3","topojson","../common/SVGWidget","./Utility","css!./Layered"],e):t.map_Layered=e(t.d3,t.topojson,t.common_SVGWidget,t.map_Utility)}(this,function(t,e,o,r){function i(){o.call(this),this._drawStartPos="origin",this._layers=[],this.projection("mercator")}var n=.25,a=2048/Math.PI;return i.prototype=Object.create(o.prototype),i.prototype.constructor=i,i.prototype._class+=" map_Layered",i.prototype.publish("projection",null,"set","Map projection type",["albersUsa","albersUsaPr","azimuthalEqualArea","azimuthalEquidistant","conicEqualArea","conicConformal","conicEquidistant","equirectangular","gnomonic","mercator","orthographic","stereographic","transverseMercator"]),i.prototype.publish("centerLat",0,"number","Center Latitude",null,{tags:["Basic"]}),i.prototype.publish("centerLong",0,"number","Center Longtitude",null,{tags:["Basic"]}),i.prototype.publish("zoom",1,"number","Zoom Level",null,{tags:["Basic"]}),i.prototype.projection_orig=i.prototype.projection,i.prototype.projection=function(e){var o=i.prototype.projection_orig.apply(this,arguments);if(arguments.length){switch(this._d3GeoProjection=t.geo[e]().scale(a).translate([0,0]),e){case"orthographic":this._d3GeoProjection.clipAngle(90).rotate([0,0])}this._d3GeoPath=t.geo.path().projection(this._d3GeoProjection),this._zoomToFitOnNextRender=!0}return o},i.prototype.layers=function(t){return arguments.length?(this._layers=t,this):this._layers},i.prototype.size=function(t){var e=o.prototype.size.apply(this,arguments);return arguments.length&&(delete this._prevCenterLat,delete this._prevCenterLong),e},i.prototype.enter=function(e,r){o.prototype.enter.apply(this,arguments);var i=this;this._zoom=t.behavior.zoom().scaleExtent([.25*n,131072*n]).on("zoomstart",function(t){i._zoomstart_translate=i._zoom.translate(),i._zoomstart_scale=i._zoom.scale()}).on("zoom",function(){if(t.event&&t.event.sourceEvent&&t.event.sourceEvent.ctrlKey&&"mousemove"===t.event.sourceEvent.type)return void i.render();i.zoomed();var e=i.width()/2,o=i.height()/2,r=i.invert(e,o);i.centerLong(r[0]),i.centerLat(r[1]),i.zoom(i._zoom.scale()/n),i._prevCenterLong=i.centerLong(),i._prevCenterLat=i.centerLat(),i._prevZoom=i.zoom()}).on("zoomend",function(){}),this._zoomGrab=r.append("rect").attr("class","background"),this._layersTarget=r.append("g"),r.call(this._zoom)},i.prototype.update=function(e,r){if(o.prototype.update.apply(this,arguments),this._prevCenterLat!==this.centerLat()||this._prevCenterLong!==this.centerLong()||this._prevZoom!==this.zoom()){var i=t.geo[this.projection()]().scale(this.zoom()*n*a).translate([this.width()/2,this.height()/2]),s=i([this.centerLong(),this.centerLat()])||[this.width()/2,this.height()/2];this._zoom.scale(this.zoom()*n).translate([this.width()-s[0],this.height()-s[1]]),this._prevCenterLat=this.centerLat(),this._prevCenterLong=this.centerLong(),this._prevZoom=this.zoom()}this._zoomGrab.attr("width",this.width()).attr("height",this.height());var h=this._layersTarget.selectAll(".layerContainer").data(this.layers().filter(function(t){return t.visible()}),function(t){return t.id()}),p=this;h.enter().append("g").attr("class","layerContainer").each(function(e){e._svgElement=t.select(this),e._domElement=p._parentOverlay.append("div"),e.layerEnter(p,e._svgElement,e._domElement)}),h.each(function(t){t.layerUpdate(p)}),h.exit().each(function(t){t.layerExit(p),t._domElement.remove()}).remove(),h.order(),this.zoomed()},i.prototype.exit=function(t,e){o.prototype.enter.apply(this,arguments)},i.prototype.zoomed=function(){var t=this._layersTarget.selectAll(".layerContainer"),e=this;t.each(function(t){t.layerZoomed(e)})},i.prototype.render=function(t){var e=o.prototype.render.apply(this,arguments);return this._renderCount&&this._zoomToFitOnNextRender&&(this._zoomToFitOnNextRender=!1,this.zoomToFit()),e},i.prototype.project=function(t,e){t>=90?t=89:-90>=t&&(t=-89);var o=this._d3GeoProjection([e,t]);return o&&(o[0]*=this._zoom.scale(),o[1]*=this._zoom.scale(),o[0]+=this._zoom.translate()[0],o[1]+=this._zoom.translate()[1]),o},i.prototype.invert=function(t,e){return t-=this._zoom.translate()[0],e-=this._zoom.translate()[1],t/=this._zoom.scale(),e/=this._zoom.scale(),this._d3GeoProjection.invert([t,e])},i.prototype.zoomToFit=function(t){t=t||.95;var e=this._layersTarget.node().getBBox();if(e.width&&e.height){var o=this._zoom.translate(),r=e.x+e.width/2,i=e.y+e.height/2;o[0]-=r-this.width()/2,o[1]-=i-this.height()/2,this._zoom.translate(o);var n=this._zoom.scale(),a=n*Math.min(this.width()/e.width,this.height()/e.height);this._zoom.scale(a).event(this._layersTarget)}},i});