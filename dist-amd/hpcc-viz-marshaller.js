!function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/FlyoutButton",["../form/Button","../layout/Popup","../layout/Surface"],e):t.marshaller_FlyoutButton=e(t.form_Button,t.layout_Popup,t.layout_Surface)}(this,function(t,e,i){function a(){t.call(this),this.value("^");var a=this;this._popupSurface=(new i).surfaceBackgroundColor("rgb(234, 249, 255)").buttonAnnotations([{id:"",label:"ÔÄç",width:20,padding:"0px 5px","class":"close",font:"FontAwesome"}]).on("click",function(t){"close"===t["class"]&&a._popup.visible(!1).popupState(!1).render()}),this._popup=(new e).size({width:400,height:400}).position("absolute").widget(this._popupSurface)}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._class+=" marshaller_FlyoutButton",a.prototype.publishProxy("title","_popupSurface"),a.prototype.publishProxy("widget","_popupSurface"),a.prototype.click=function(t){var e=this;this._popup.visible(!0).popupState(!0).render(function(t){var i=e._popupSurface.widget().getBBox();e._popupSurface.resize({width:i.width,height:i.height+e._popupSurface.calcHeight(e._popupSurface.element().select(".surfaceTitle"))+18}),e._popup.render()})},a.prototype.enter=function(e,i){t.prototype.enter.apply(this,arguments);for(var a=this;a&&-1===["marshaller_HTML","marshaller_Graph"].indexOf(a.classID());)a=a.locateParentWidget();a&&(this._popupParentWidget=a,this._popup.target(a.node()))},a.prototype.render=function(e){var i=this;t.prototype.render.call(i,function(t){var a=i._popupParentWidget.getBBox(),s=t.getBBox();i._popup.left(s.x-a.x+s.width-i._popup.width()).top(s.y-a.y+s.height).visible(!1).popupState(!1).render(),e&&e(t)})},a}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/HipieDDL",["d3","../common/Database","../common/Utility","../other/Comms","../common/Widget","require"],e):t.marshaller_HipieDDL=e(t.d3,t.common_Database,t.common_Utility,t.other_Comms,t.common_Widget,t.require)}(this,function(t,e,i,a,s,o){function r(t,e){for(var i=t.split("."),a=e,s=0;s<i.length;++s){var o=i[s];if(!a||void 0===a[o])return!1;a=a[o]}return!0}function n(t){return t?String.fromCharCode(parseInt(t)):t}function u(t,e){this.visualization=t;var i={};for(var a in e)e[a]instanceof Array?e[a].forEach(function(t,e){i[0===e?a:a+"_"+e]=t}):i[a]=e[a];this.mappings=i,this.hasMappings=!1,this.reverseMappings={},this.columns=[],this.columnsIdx={},this.columnsRHS=[],this.columnsRHSIdx={}}function p(t){switch(t){case"bool":case"boolean":return"boolean";case"integer":case"float":case"double":return"number";case"date":case"time":return"time"}return"string"}function h(t,e){u.call(this,t,e),this.columns=["label","weight"],this.columnsIdx={label:0,weight:1},this.init()}function l(t,e){u.call(this,t,e),e.state?(this.columns=["state","weight"],this.columnsIdx={state:0,weight:1}):e.county?(this.columns=["county","weight"],this.columnsIdx={county:0,weight:1}):e.geohash&&(this.columns=["geohash","weight"],this.columnsIdx={geohash:0,weight:1}),this.init()}function c(t,e){u.call(this,t,e),e.state?(this.columns=["state"],this.columnsIdx={state:0}):e.county?(this.columns=["county"],this.columnsIdx={county:0}):e.geohash&&(this.columns=["geohash"],this.columnsIdx={geohash:0}),e.weight.forEach(function(t,e){this.columns.push(t),this.columnsIdx[0===e?"weight":"weight_"+e]=e+1},this),this.init()}function d(t,e){u.call(this,t,e),this.columns=["x","y","weight"],this.columnsIdx={x:0,y:1,weight:2},this.init()}function f(t,e){var i={label:e.x[0]};e.y.forEach(function(t,e){i[t]=t}),u.call(this,t,i),this.init()}function g(t,e){var i={};for(var a in e)e[a].forEach(function(e,a){i[t.label[a]]=e});u.call(this,t,i),this.init()}function m(t,e,i){u.call(this,t,e),this.icon=t.icon||{},this.fields=t.fields||{},this.columns=["uid","label","weight","flags"],this.columnsIdx={uid:0,label:1,weight:2,flags:3},this.init(),this.link=i,this.visualization=t}function v(t,e){if(this.visualization=t,e){switch(this._id=e.id,this._output=e.output,this.mappings=null,e.mappings||console.log("no mappings for:"+t.id+"->"+e.id),this.visualization.type){case"LINE":this.mappings=new f(this.visualization,e.mappings);break;case"TABLE":this.mappings=new g(this.visualization,e.mappings);break;case"GRAPH":this.mappings=new m(this.visualization,e.mappings,e.link);break;case"CHORO":e.mappings.weight instanceof Array&&e.mappings.weight.length?(this.mappings=new c(this.visualization,e.mappings,e.link),e.mappings.weight.length>1&&(this.visualization.type="LINE")):this.mappings=new l(this.visualization,e.mappings,e.link);break;case"HEAT_MAP":this.mappings=new d(this.visualization,e.mappings,e.link);break;default:this.mappings=new h(this.visualization,e.mappings)}this.first=e.first,this.reverse=e.reverse,this.sort=e.sort}}function y(t,e,i){this.visualization=t,this.eventID=e,i&&(this._updates=i.updates,this.mappings=i.mappings)}function _(t,e){this.visualization=t,this.events={};for(var i in e)this.events[i]=new y(t,i,e[i])}function b(t,e){this.dashboard=t,this.id=e.id,this.label=e.label,this.title=e.title||e.id,this.type=e.type,this.icon=e.icon||{},this.fields=e.fields||{},this.properties=e.properties||(e.source?e.source.properties:null)||{},this.source=new v(this,e.source),this.events=new _(this,e.events);var i=this;switch(this.type){case"CHORO":this.source.mappings.contains("state")?this.loadWidget("src/map/ChoroplethStates",function(t){t.id(e.id).paletteID_default(e.color)}):this.source.mappings.contains("county")?this.loadWidget("src/map/ChoroplethCounties",function(t){t.id(e.id).paletteID_default(e.color)}):this.source.mappings.contains("geohash")&&this.loadWidget("src/map/Layered",function(t){t.id(e.id)});break;case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":this.loadWidget("src/composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").chartType_default(i.properties.chartType||i.properties.charttype||i.type)});break;case"LINE":this.loadWidget("src/composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").chartType_default(i.properties.chartType||i.properties.charttype||i.type)});break;case"TABLE":this.loadWidget("src/composite/MegaChart",function(t){t.id(e.id).legendPosition_default("none").showChartSelect_default(!1).chartType_default("TABLE").chartTypeDefaults({pagination:!0})});break;case"SLIDER":this.loadWidget("src/form/Slider",function(t){if(t.id(e.id),e.range){var i="";for(var a in e.events.events.mappings){i=a;break}t.low_default(+e.range[0]).high_default(+e.range[1]).step_default(+e.range[2]).selectionLabel_default(i)}});break;case"GRAPH":this.loadWidgets(["src/graph/Graph"],function(t){t.id(e.id).layout_default("ForceDirected2").applyScaleOnLayout_default(!0)});break;case"FORM":this.loadWidgets(["src/form/Form","src/form/Input","src/form/Button","src/form/CheckBox","src/form/ColorInput","src/form/Radio","src/form/Range","src/form/Select","src/form/Slider","src/form/TextArea"],function(t,i){var a=i[1],s=i[3],o=i[5],r=i[7],n=i[9];t.id(e.id).inputs(e.fields.map(function(t){var e,i=[],u=[];switch(t.properties.charttype){case"TEXT":e=(new a).type_default("text");break;case"TEXTAREA":e=new n;break;case"CHECKBOX":e=new s;break;case"RADIO":e=new o;break;case"HIDDEN":e=(new a).type_default("hidden");break;default:if(t.properties.enumvals){e=new r,u=t.properties.enumvals;for(var p in u)i.push([p,u[p]])}else e=(new a).type_default("text")}if(e.name_default(t.id).label_default((t.properties?t.properties.label:null)||t.label).value_default(t.properties["default"]?t.properties["default"]:""),e instanceof s||e instanceof o){var h=Object.keys(t.properties.enumvals);e.selectOptions_default(h)}else i.length&&e.selectOptions_default(i);return e}))});break;case"HEAT_MAP":this.loadWidgets(["src/other/HeatMap"],function(t){t.id(e.id).image_default(i.properties.imageUrl)});break;default:this.loadWidget("src/common/TextBox",function(t){t.id(e.id).text_default(i.id+"\nTODO:  "+i.type)})}}function w(t,e){this.dataSource=t,this.id=e.id,this.from=e.from,this.request={},this.notify=e.notify||[],this.filter=e.filter||[]}function D(t,e,i){this.dashboard=t,this.id=e.id,this.filter=e.filter||[],this.WUID=e.WUID,this.URL=e.URL,this.databomb=e.databomb,this.request={},this._loadedCount=0;var s=this;this.outputs={};var o=[];e.outputs.forEach(function(t){s.outputs[t.id]=new w(s,t),o.push({id:t.id,from:t.from,filter:t.filter||this.filter})},this),this.WUID?this.comms=(new a.HIPIEWorkunit).url(t.marshaller.espUrl._url).proxyMappings(i).hipieResults(o):this.databomb?this.comms=(new a.HIPIEDatabomb).hipieResults(o):this.comms=(new a.HIPIERoxie).url(e.URL).proxyMappings(i)}function z(t,e,i){this.marshaller=t,this.id=e.id,this.title=e.title;var a=this;this.datasources={},this.datasourceTotal=0,e.datasources.forEach(function(t){a.datasources[t.id]=new D(a,t,i),++a.datasourceTotal}),this._visualizations={},this._visualizationArray=[],e.visualizations.forEach(function(t){var e=new b(this,t);this._visualizations[t.id]=e,this._visualizationArray.push(e),this.marshaller._visualizations[t.id]=e,this.marshaller._visualizationArray.push(e)},this),this._visualizationTotal=this._visualizationArray.length}function x(){this._proxyMappings={},this._widgetMappings=t.map(),this._clearDataOnUpdate=!0,this._propogateClear=!1}var M="...loading...";return u.prototype.init=function(){for(var t in this.mappings)this.reverseMappings[this.mappings[t]]=t,void 0===this.columnsIdx[t]&&(this.columns.push(t),this.columnsIdx[t]=this.columns.length-1),this.columnsRHS[this.columnsIdx[t]]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=this.columnsIdx[t],this.hasMappings=!0},u.prototype.getFields=function(){return this.visualization.fields?Object.keys(this.mappings).map(function(t){return this.visualization.fields.filter(function(e){return e.id===this.mappings[t]},this).map(function(t){return new e.Field(t.id).type(p(t.properties.type)).label(this.reverseMappings[t.id])},this)[0]},this):null},u.prototype.contains=function(t){return void 0!==this.mappings[t]},u.prototype.doMap=function(t){var e=[];for(var i in this.mappings){var a=this.mappings[i];try{var s=t[a];void 0===s&&(s=t[a.toLowerCase()]),e[this.columnsIdx[i]]=s}catch(o){console.log("Invalid Mapping:  "+this.visualization.id+" ["+a+"->"+t+"]")}}return e},u.prototype.doMapAll=function(t){return t.hipieMappings(this.columnsRHS)},u.prototype.getMap=function(t){return this.mappings[t]},u.prototype.getReverseMap=function(t){return this.reverseMappings[t]},h.prototype=Object.create(u.prototype),l.prototype=Object.create(u.prototype),c.prototype=Object.create(u.prototype),d.prototype=Object.create(u.prototype),f.prototype=Object.create(u.prototype),g.prototype=Object.create(u.prototype),g.prototype.init=function(){this.visualization.label.forEach(function(t,e){this.reverseMappings[this.mappings[t]]=t,this.columns.push(t),this.columnsIdx[t]=e,this.columnsRHS[e]=this.mappings[t],this.columnsRHSIdx[this.mappings[t]]=e,this.hasMappings=!0},this)},m.prototype=Object.create(u.prototype),m.prototype.calcAnnotation=function(t,e,i){function a(t,e){if(t)for(var a in t)switch(a){case"faChar":e.faChar=n(t.faChar);break;case"tooltip":e[a]=t[a];break;case"icon_image_colorFill":case"icon_shape_colorFill":case"icon_shape_colorStroke":i?e[a.split("icon_")[1]]=t[a]:e[a]=t[a];break;case"textbox_image_colorFill":case"textbox_shape_colorFill":case"textbox_shape_colorStroke":i||(e[a]=t[a]);break;case"id":case"valuemappings":case"font":case"charttype":break;default:console.log("Unknown annotation property:  "+a)}}var s={};if(a(t,s),e&&e[t.id]&&t.valuemappings){var o=t.valuemappings[e[t.id]];a(o,s)}for(var r in s)return s;return null},m.prototype.doMapAll=function(t){function e(t,e){var i="uid_"+t[0],u=s[i];if(u||(u=(new r.Vertex).faChar(a.icon&&a.icon.faChar?n(a.icon.faChar):"ÔÑ®").text(t[1]?t[1]:""),u.__hpcc_uid=t[0],s[i]=u,o.push(u)),e){t[1]&&u.text(t[1]);var p=a.calcAnnotation(a.visualization.icon,e);if(p)for(var h in p)u[h]&&u[h](p[h]);var l=[];a.fields.forEach(function(t){var i=a.calcAnnotation(t,e,!0);i&&l.push(i)}),u.annotationIcons(l)}return u}var i=t.jsonObj(),a=this,s={},o=[],r=this.visualization.widget,u=[];return i.forEach(function(t){var i=a.doMap(t),s=e(i,t);if(t[a.link.childfile]&&t[a.link.childfile].Row){var o=t[a.link.childfile].Row;o.forEach(function(t,i){var o=a.doMap(t),n=e(o);if(s.id()!==n.id()){var p=(new r.Edge).sourceVertex(s).targetVertex(n).sourceMarker("circleFoot").targetMarker("arrowHead");u.push(p)}})}}),{vertices:o,edges:u,merge:!1}},v.prototype.getQualifiedID=function(){return this.visualization.getQualifiedID()+"."+this.id},v.prototype.exists=function(){return this._id},v.prototype.getDatasource=function(){return this.visualization.dashboard.datasources[this._id]},v.prototype.getOutput=function(){var t=this.getDatasource();return t&&t.outputs?t.outputs[this._output]:null},v.prototype.hasData=function(){return this.getOutput().db?!0:!1},v.prototype.getFields=function(){return this.mappings.getFields()},v.prototype.getColumns=function(){return this.mappings.columns},v.prototype.getData=function(){var t=this.getOutput().db,e=t.data();e.length&&this.sort&&i.multiSort(e,t.hipieMapSortArray(this.sort));var a=this.mappings.doMapAll(t);return this.reverse&&a.reverse(),this.first&&a.length>this.first&&(a.length=this.first),a},v.prototype.getXTitle=function(){return this.mappings.columns[0]},v.prototype.getYTitle=function(){return this.mappings.columns.filter(function(t,e){return e>0}).join(" / ")},y.prototype.exists=function(){return void 0!==this._updates},y.prototype.getUpdates=function(){var t=[];return r("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(e,i){var a=this.visualization.dashboard.datasources[e.datasource],s=this.visualization.dashboard.getVisualization(e.visualization);t.push({eventID:this.eventID,datasource:a,visualization:s})},this),t},y.prototype.getUpdatesDatasources=function(){var t={},e=[];return this.getUpdatesVisualizations().forEach(function(i,a){var s=i.source.getDatasource();s&&!t[s.id]&&(t[s.id]=!0,e.push(s))},this),e},y.prototype.getUpdatesVisualizations=function(){var t={},e=[];return r("_updates",this)&&this._updates instanceof Array&&this._updates.forEach(function(i,a){var s=this.visualization.dashboard.getVisualization(i.visualization);t[s.id]||(t[s.id]=!0,e.push(s))},this),e},_.prototype.setWidget=function(t){var e=this;for(var i in this.events)t["vertex_"+i]?t["vertex_"+i]=function(t){e.visualization.onEvent(i,e.events[i],t)}:t[i]&&(t[i]=function(t,a,s){e.visualization.onEvent(i,e.events[i],t,a,s)})},_.prototype.exists=function(){return void 0!==this._updates},_.prototype.getUpdates=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdates());return t},_.prototype.getUpdatesDatasources=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdatesDatasources());return t},_.prototype.getUpdatesVisualizations=function(){var t=[];for(var e in this.events)t=t.concat(this.events[e].getUpdatesVisualizations());return t},b.prototype.getQualifiedID=function(){return this.id},b.prototype.isLoading=function(t,e){return null===this.widget},b.prototype.isLoaded=function(t,e){return this.widget instanceof s},b.prototype.loadWidget=function(t,e){this.loadWidgets([t],e)},b.prototype.loadWidgets=function(t,e){this.widget=null;var i=this;o(t,function(t){i.dashboard.marshaller._widgetMappings.has(i.id)?i.setWidget(i.dashboard.marshaller._widgetMappings.get(i.id)):i.setWidget(new t),e&&e(i.widget,arguments)})},b.prototype.setWidget=function(t){this.widget=t,this.events.setWidget(t);for(var e in this.properties)switch(t.classID()){case"chart_MultiChart":case"composite_MegaChart":t.chartTypeDefaults()[e]=this.properties[e];break;default:if(this.widget[e+"_default"])try{this.widget[e+"_default"](this.properties[e])}catch(i){console.log("Invalid Property:"+this.id+".properties."+e)}}return this.widget},b.prototype.accept=function(t){t.visit(this)},b.prototype.update=function(t){var e=this.getInputVisualizations(),i=[];e.forEach(function(t){for(var e in t._eventValues)i.push(t._eventValues[e])});for(var a=t||i.join(", "),s=this.widget;s&&!s.title;)s=s.locateParentWidget();if(s){var o=s.title(),r=o.split(" (");s.title(r[0]+(a?" ("+a+")":"")).render()}else this.widget.render()},b.prototype.notify=function(){if(this.source.hasData()&&this.widget){if(!this.widget.fields().length){var t=this.source.getColumns();this.widget.columns(t)}var e=this.source.getData();this.widget.data(e),this.update()}},b.prototype.clear=function(){this.widget&&this.dashboard.marshaller.clearDataOnUpdate()&&(this.widget.data([]),this.source.getOutput().request={}),this.dashboard.marshaller.propogateClear()&&this._eventValues&&(delete this._eventValues,this.events.getUpdatesVisualizations().forEach(function(t){t.clear()})),this.update(M)},b.prototype.onEvent=function(t,e,i,a,s){var o=this;setTimeout(function(){if(s=void 0===s?!0:s,e.exists()){var t={};if(s)for(var a in e.mappings){var r=o.source.mappings&&o.source.mappings.hasMappings?o.source.mappings.getReverseMap(a):a;t[e.mappings[a]]=i[r]}o._eventValues=t;var n={},u=e.getUpdatesVisualizations();u.forEach(function(t){var e=t.source.getDatasource();n[e.id]||(n[e.id]={datasource:e,request:{},updates:[]}),n[e.id].updates.push(t.id),t.getInputVisualizations().forEach(function(t,i){if(t._eventValues)for(var a in t._eventValues)n[e.id].request[a]&&n[e.id].request[a]!==t._eventValues[a]&&console.log("Duplicate Filter, with mismatched value:  "+a+"="+t._eventValues[a]),n[e.id].request[a]=t._eventValues[a],n[e.id].request[a+"_changed"]=t===o}),"GRAPH"!==t.type&&t.clear(),(e.WUID||e.databomb)&&e.fetchData(n[e.id].request,!1,[t.id])});for(var p in n)n[p].datasource.WUID||n[p].datasource.databomb||n[p].datasource.fetchData(n[p].request,!1,n[p].updates)}},0)},b.prototype.getInputVisualizations=function(){return this.dashboard.marshaller.getVisualizationArray().filter(function(t){var e=t.events.getUpdatesVisualizations();return e.indexOf(this)>=0?!0:!1},this)},w.prototype.getQualifiedID=function(){return this.dataSource.getQualifiedID()+"."+this.id},w.prototype.accept=function(t){t.visit(this)},w.prototype.vizNotify=function(t){this.notify.filter(function(e){return!t||t.indexOf(e)>=0}).forEach(function(t){var e=this.dataSource.dashboard.getVisualization(t);e.notify()},this)},w.prototype.setData=function(t,i,a){this.request=i,this.db=(new e.Grid).jsonObj(t),this.vizNotify(a)},D.prototype.getQualifiedID=function(){return this.dashboard.getQualifiedID()+"."+this.id},D.prototype.accept=function(t){t.visit(this);for(var e in this.outputs)this.outputs[e].accept(t)},D.prototype.fetchData=function(t,e,i){if(!i){i=[];for(var a in this.outputs){var s=this.outputs[a];s.notify.forEach(function(t){s.filter&&s.filter.length||i.push(t);var e=this.dashboard.getVisualization(t);e.update(M)},this)}}var o=this;this.request.refresh=e?!0:!1,this.filter.forEach(function(e){this.request[e+"_changed"]=t[e+"_changed"]||!1;var i=void 0===t[e]?null:t[e];this.request[e]!==i&&(this.request[e]=i)},this),window.__hpcc_debug&&console.log("fetchData:  "+JSON.stringify(i)+"("+JSON.stringify(t)+")");for(var r in this.request)null===this.request[r]&&delete this.request[r];var n=Date.now();this.comms.call(this.request).then(function(e){var a=500-(Date.now()-n);setTimeout(function(){o.processResponse(e,t,i),++o._loadedCount},a>0?a:0)})["catch"](function(t){o.dashboard.marshaller.commsError("DataSource.prototype.fetchData",t)})},D.prototype.processResponse=function(t,e,i){var a={};for(var s in t)a[s.toLowerCase()]=t[s];for(var o in this.outputs){var n=this.outputs[o].from;if(n||(n=this.outputs[o].id.toLowerCase()),r(n,t))!r(n+"_changed",t)||r(n+"_changed",t)&&t[n+"_changed"].length&&t[n+"_changed"][0][n+"_changed"]?this.outputs[o].setData(t[n],e,i):this.outputs[o].vizNotify(i);else if(r(n,a))console.log("DDL 'DataSource.From' case is Incorrect"),!r(n+"_changed",a)||r(n+"_changed",a)&&t[n+"_changed"].length&&a[n+"_changed"][0][n+"_changed"]?this.outputs[o].setData(a[n],e,i):this.outputs[o].vizNotify(i);else{var u=[];for(var p in t)u.push(p);console.log("Unable to locate '"+n+"' in response {"+u.join(", ")+"}")}}},z.prototype.getQualifiedID=function(){return this.id},z.prototype.getVisualization=function(t){return this._visualizations[t]||this.marshaller.getVisualization(t)},z.prototype.getVisualizations=function(){return this._visualizations},z.prototype.getVisualizationArray=function(){return this._visualizationArray},z.prototype.getVisualizationTotal=function(){return this._visualizationTotal},z.prototype.accept=function(t){t.visit(this);for(var e in this.datasources)this.datasources[e].accept(t);this._visualizationArray.forEach(function(e){e.accept(t)},this)},z.prototype.allVisualizationsLoaded=function(){var t=this._visualizationArray.filter(function(t){return!t.isLoaded()});return 0===t.length},x.prototype.commsDataLoaded=function(){for(var t=0;t<this.dashboardArray.length;t++)for(var e in this.dashboardArray[t].datasources)if(0===this.dashboardArray[t].datasources[e]._loadedCount)return!1;return!0},x.prototype.getVisualization=function(t){return this._visualizations[t]},x.prototype.accept=function(t){t.visit(this),this.dashboardTotal=0;for(var e in this.dashboards)this.dashboards[e].accept(t),++this.dashboardTotal},x.prototype.url=function(t,e){this.espUrl=(new a.ESPUrl).url(t);var i=null,s="HIPIE_DDL";this.espUrl.isWorkunitResult()?(s=this.espUrl._params.ResultName,i=(new a.HIPIEWorkunit).url(t).proxyMappings(this._proxyMappings)):i=(new a.HIPIERoxie).url(t).proxyMappings(this._proxyMappings);var o={refresh:!1},n=this;i.call(o).then(function(t){return r(s,t)?i.fetchResult(s).then(function(i){var a=i[0][s];n.parse(a,function(){e(t)})})["catch"](function(t){n.commsError("Marshaller.prototype.url",t)}):void 0})["catch"](function(t){n.commsError("Marshaller.prototype.url",t)})},x.prototype.proxyMappings=function(t){return arguments.length?(this._proxyMappings=t,this):this._proxyMappings},x.prototype.widgetMappings=function(t){return arguments.length?(this._widgetMappings=t,this):this._widgetMappings},x.prototype.clearDataOnUpdate=function(t){return arguments.length?(this._clearDataOnUpdate=t,this):this._clearDataOnUpdate},x.prototype.propogateClear=function(t){return arguments.length?(this._propogateClear=t,this):this._propogateClear},x.prototype.parse=function(t,e){var i=this;return this._json=t,this._jsonParsed=JSON.parse(this._json),this.dashboards={},this.dashboardArray=[],this._visualizations={},this._visualizationArray=[],this._jsonParsed.forEach(function(t){var e=new z(i,t,i._proxyMappings);i.dashboards[t.id]=e,i.dashboardArray.push(e)}),this.dashboardTotal=this.dashboardArray.length,this.ready(e),this},x.prototype.getVisualizations=function(){return this._visualizations},x.prototype.getVisualizationArray=function(){return this._visualizationArray},x.prototype.on=function(t,e){if(void 0===this[t])throw"Method:  "+t+" does not exist.";var i=this[t];return this[t]=function(){i.apply(this,arguments),e.apply(this,arguments)},this},x.prototype.allDashboardsLoaded=function(){return 0===this.dashboardArray.filter(function(t){return!t.allVisualizationsLoaded()}).length},x.prototype.ready=function(t){function e(t){i.allDashboardsLoaded()?t():setTimeout(e,100,t)}if(t){var i=this;e(t)}},x.prototype.commsError=function(t,e){console.log("Comms Error:\n"+t+"\n"+e)},{exists:r,Marshaller:x,Dashboard:z,DataSource:D,Output:w,Visualization:b}}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/Graph",["d3","../common/SVGWidget","../common/TextBox","../common/Surface","../common/ResizeSurface","../chart/MultiChartSurface","../common/Palette","../graph/Graph","../graph/Vertex","../graph/Edge","./HipieDDL"],e):t.marshaller_Graph=e(t.d3,t.common_SVGWidget,t.common_TextBox,t.common_Surface,t.common_ResizeSurface,t.chart_MultiChartSurface,t.common_Palette,t.graph_Graph,t.graph_Vertex,t.graph_Edge,t.marshaller_HipieDDL)}(this,function(t,e,i,a,s,o,r,n,u,p,h){function l(t,e,o){function n(t,e,i,a,s,o){a=a||"",s=s||"",o=o||"",e&&i&&t.vertexMap[e]&&t.vertexMap[i]?t.edges.push((new p).sourceVertex(t.vertexMap[e]).targetVertex(t.vertexMap[i]).sourceMarker(a).targetMarker(s).text(o)):(t.vertexMap[e]||console.log("Unknown Vertex:  "+e),t.vertexMap[i]||console.log("Unknown Vertex:  "+i))}e instanceof Object||e&&(e=JSON.parse(e));var l=null,c={},d={},f=[];return t.accept({_visualizeRoxie:o,visit:function(t){if(t instanceof h.Dashboard)l={dashboard:t,vertexMap:d,edges:f},c[t.getQualifiedID()]=l;else if(t instanceof h.DataSource){if(t.databomb&&e[t.id]&&t.comms.databomb(e[t.id]),this._visualizeRoxie){var o="";t.filter.forEach(function(t){o.length>0&&(o+=", "),o+=t}),o=" ("+o+")",l.vertexMap[t.getQualifiedID()]=(new u)["class"]("vertexLabel").faChar("ÔáÄ").text(t.id+o)}}else if(t instanceof h.Output)t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from),this._visualizeRoxie&&(l.vertexMap[t.getQualifiedID()]=(new u)["class"]("vertexLabel").faChar("ÔÉé").text(t.id+"\n["+t.from+"]"));else if(t instanceof h.Visualization&&t.widget){var n=null;if(t.widget instanceof a)n=t.widget.size({width:210,height:210});else if(t.widget instanceof i)n=t.widget;else{var p=280,g=210;"GRAPH"===t.type&&(p=800,g=600),n=(new s).size({width:p,height:g}).title(t.title).content(t.widget)}if(n)switch(t.widgetSurface=n,l.vertexMap[t.getQualifiedID()]=n,t.type){case"2DCHART":case"PIE":case"BUBBLE":case"BAR":case"WORD_CLOUD":n.menu(t.widget._2DChartTypes.concat(t.widget._NDChartTypes.concat(t.widget._anyChartTypes)).map(function(t){return t.display}).sort()),n._menu.click=function(e){t.widget.chartType(e).render()};break;case"LINE":n.menu(t.widget._NDChartTypes.concat(t.widget._anyChartTypes).map(function(t){return t.display}).sort()),n._menu.click=function(e){t.widget.chartType(e).render()};break;case"CHORO":n._menu.data(r.rainbow()),n._menu.click=function(t){n._content.paletteID(t).render(t)};break;case"GRAPH":n._menu.data(["Circle","ForceDirected","ForceDirected2","Hierarchy"]),n._menu.click=function(t){n._content.layout(t)}}}}}),l=null,t.accept({_visualizeRoxie:o,visit:function(t){t instanceof h.Dashboard?l=c[t.getQualifiedID()]:t instanceof h.DataSource||(t instanceof h.Output?this._visualizeRoxie&&n(l,t.dataSource.getQualifiedID(),t.getQualifiedID(),"circleFoot","circleHead"):t instanceof h.Visualization&&(this._visualizeRoxie&&(t.source.getDatasource()&&n(l,t.getQualifiedID(),t.source.getDatasource().getQualifiedID(),"","arrowHead","update"),t.source.getOutput()&&n(l,t.source.getOutput().getQualifiedID(),t.getQualifiedID(),"","arrowHead","notify")),t.events.getUpdates().forEach(function(e){n(l,t.getQualifiedID(),e.visualization.getQualifiedID(),void 0,"arrowHead","on "+e.eventID)})))}}),c}function c(){n.call(this),this._design_mode=!1,this._dashboards=[],this.graphAttributes=["snapToGrid","showEdges"],this.widgetAttributes=["layout","chartType","palette","title","columns","data"]}var d=2;return c.prototype=Object.create(n.prototype),c.prototype.constructor=c,c.prototype._class+=" marshaller_Graph",c.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),c.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),c.prototype.publish("visualizeRoxie",!1,"boolean","Show Roxie Data Sources",null,{tags:["Private"]}),c.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),c.prototype.design_mode=function(t){return arguments.length?(this._design_mode=t,this.showEdges(this._designMode).snapToGrid(this._designMode?12:0).allowDragging(this._designMode),this.data().vertices&&this.data().vertices.forEach(function(t){t.show_title(this._design_mode).render()},this),this):this._design_mode},c.prototype.dashboards=function(t){return arguments.length?(this._dashboards=t,this):this._dashboards},c.prototype.title=function(){var t="";return this._dashboards.forEach(function(e){t&&(t+=", "),t+=e.dashboard.title}),t},c.prototype.renderDashboards=function(t){this.data({vertices:[],edges:[]});var e=[],i=[];for(var a in this._dashboards){for(var s in this._dashboards[a].vertexMap)e.push(this._dashboards[a].vertexMap[s]);i=i.concat(this._dashboards[a].edges)}this.data({vertices:e,edges:i});var o=t?this.load():{changed:!1,dataChanged:!1};return o.changed&&this.layout(""),this},c.prototype.fetchData=function(){for(var t in this._dashboards){var e=this._dashboards[t].dashboard;for(var i in e.datasources)e.datasources[i].fetchData({},!0)}return this},c.prototype.checksum=function(t){var e,i,a=0,s=t.length;if(0===s)return a;for(e=0;s>e;e++)i=t.charCodeAt(e),a=(a<<5)-a+i,a&=a;return a},c.prototype.calcHash=function(){var t=this,e=d;for(var i in this._dashboards){var a=this._dashboards[i].dashboard;a.accept({visit:function(i){i instanceof h.Visualization&&(e+=t.checksum(i.getQualifiedID()))}})}return e},c.prototype.clear=function(){localStorage.setItem("Graph_"+this.calcHash(),"")},c.prototype.serialize=function(t,e){t=t||[],e=e||[];var i={};i.zoom={translation:this.zoom.translate(),scale:this.zoom.scale()},t.forEach(function(t){this[t]&&(i[t]=this[t]())},this);for(var a in this._dashboards){var s=this._dashboards[a].dashboard,o=s.getQualifiedID();i[o]={},s.accept({visit:function(t){if(t instanceof h.Visualization&&t.widgetSurface){var a={pos:t.widgetSurface.pos(),size:t.widgetSurface.size()};e.forEach(function(e){t.widget[e]?a[e]=t.widget[e]():t.widgetSurface[e]&&(a[e]=t.widgetSurface[e]())}),i[o][t.getQualifiedID()]=a}}})}return JSON.stringify(i)},c.prototype.save=function(){localStorage.setItem("Graph_"+this.calcHash(),this.serialize(this.graphAttributes,this.widgetAttributes))},c.prototype.deserialize=function(t,e,i){e=e||[],i=i||[];var a=!1,s=!1;e.forEach(function(e){this[e]&&void 0!==t[e]&&this[e](t[e])},this),t.zoom&&(this.setZoom(t.zoom.translation,t.zoom.scale),a=!0);for(var o in this._dashboards){var r=this._dashboards[o].dashboard,n=r.getQualifiedID();r.accept({visit:function(e){if(e instanceof h.Visualization&&t[n]&&t[n][e.getQualifiedID()]){var o=t[n][e.getQualifiedID()];e.widgetSurface.pos(o.pos).size(o.size),a=!0,i.forEach(function(t){e.widget[t]&&void 0!==o[t]?(e.widget[t](o[t]),"data"===t&&(s=!0)):e.widgetSurface[t]&&o[t]&&e.widgetSurface[t](o[t])})}}})}return{changed:a,dataChanged:s}},c.prototype.load=function(){var t={changed:!1,dataChanged:!1},e=localStorage.getItem("Graph_"+this.calcHash());return e&&(t=this.deserialize(JSON.parse(e),this.graphAttributes,this.widgetAttributes)),t},c.prototype.enter=function(t,e){n.prototype.enter.apply(this,arguments),e.classed("graph_Graph",!0)},c.prototype.update=function(t,e){n.prototype.update.apply(this,arguments)},c.prototype.render=function(t){function e(){var e=l(a,i.databomb(),i.visualizeRoxie());i.dashboards(e),i.applyScaleOnLayout(!0).layout("Hierarchy").renderDashboards(!0),n.prototype.render.call(i,function(e){i.fetchData();var s=0,o=setInterval(function(){(a.commsDataLoaded()||++s>120)&&(clearInterval(o),t&&t(e))},500)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb&&this._prev_visualizeRoxie===this.visualizeRoxie())return n.prototype.render.apply(this,arguments);this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb(),this._prev_visualizeRoxie=this.visualizeRoxie();var i=this,a=(new h.Marshaller).proxyMappings(this.proxyMappings()).on("commsError",function(t,e){i.commsError(t,e)});return"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?a.parse(this.ddlUrl(),function(){e()}):a.url(this.ddlUrl(),function(){e()}),this},c.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},c}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/HTML",["d3","../layout/Grid","./HipieDDL","../layout/Surface","../layout/Cell","../layout/Popup","../other/Persist","./FlyoutButton"],e):t.marshaller_HTML=e(t.d3,t.layout_Grid,t.marshaller_HipieDDL,t.layout_Surface,t.layout_Cell,t.layout_Popup,t.other_Persist,t.marshaller_FlyoutButton)}(this,function(t,e,i,a,s,o,r,n){function u(){
e.call(this),this.surfacePadding(0)}function p(t,e){e instanceof Object||e&&(e=JSON.parse(e));var a=null,s={};return t.accept({visit:function(t){t instanceof i.Dashboard?(a={dashboard:t,visualizations:[]},s[t.getQualifiedID()]=a):t instanceof i.DataSource?t.databomb&&e[t.id]&&t.comms.databomb(e[t.id]):t instanceof i.Output?t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from):t instanceof i.Visualization&&t.widget&&a.visualizations.push(t)}}),s}return u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype._class+=" marshaller_HTML",u.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),u.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),u.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),u.prototype.publish("clearDataOnUpdate",!0,"boolean","Clear data prior to refresh",null),u.prototype.publish("propogateClear",!1,"boolean","Propogate clear to dependent visualizations",null),u.prototype.enter=function(t,i){e.prototype.enter.apply(this,arguments),this.popupContainer=i.append("div").classed("popup-container",!0).style({height:"100px",position:"absolute","z-index":1e3})},u.prototype.render=function(s){function o(){var t=p(c.marshaller,c.databomb());for(var i in t){var o=[],r=[];t[i].visualizations.forEach(function(t,e){l.remove(t.id),t.properties.flyout?o.push(t):r.push(t)}),l.forEach(function(t,e){c.clearContent(e)});var u=0,h=0,d=c.cellDensity(),f=Math.floor(Math.sqrt(r.length));r.forEach(function(t,e){if(!c.marshaller.widgetMappings().get(t.id)){var i=null;for(i=t.widget instanceof a||"composite_MegaChart"===t.widget.classID()?t.widget:(new a).widget(t.widget),t.widget.size({width:0,height:0}),i.title(t.title);null!==c.getCell(u*d,h*d);)h++,h%f===0&&(u++,h=0);c.setContent(u,h,i)}}),o.forEach(function(t,e){var i=t.events.getUpdatesVisualizations();i.forEach(function(e){switch(e.widget.classID()){case"composite_MegaChart":var i=(new n).title(t.title).widget(t.widget);e.widget.toolbarWidgets().push(i)}})})}var g={};c.content().forEach(function(t){var e=t.widget();e&&"layout_Surface"===e.classID()&&(e=e.widget()),e&&(g[e.id()]=t)});for(i in t)t[i].visualizations.forEach(function(t,e){if(!t.properties.flyout){var i=t.events.getUpdatesVisualizations(),a=i.map(function(t){return g[t.id].id()});g[t.id].indicateTheseIds(a)}});e.prototype.render.call(c,function(e){for(var i in t)for(var a in t[i].dashboard.datasources)t[i].dashboard.datasources[a].fetchData({},!0);var o=0,r=setInterval(function(){(c.marshaller.commsDataLoaded()||++o>120)&&(clearInterval(r),s&&s(e))},500)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return this.marshaller&&this.marshaller.proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()),e.prototype.render.apply(this,arguments);this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearContent(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var u=[];r.widgetArrayWalker(this.content(),function(t){u.push(t)});var h=t.map(u,function(t){return t.id()}),l=t.map(u.filter(function(t){return 0!==t.id().indexOf(t._idSeed)&&0!==t.id().indexOf("_pe")}),function(t){return t.id()}),c=this;return this.marshaller=(new i.Marshaller).proxyMappings(this.proxyMappings()).clearDataOnUpdate(this.clearDataOnUpdate()).propogateClear(this.propogateClear()).widgetMappings(h).on("commsError",function(t,e){c.commsError(t,e)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this.marshaller.parse(this.ddlUrl(),function(){o()}):this.marshaller.url(this.ddlUrl(),function(){o()}),this},u.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},u}),function(t,e){"function"==typeof define&&define.amd?define("src/marshaller/Tabbed",["d3","../layout/Tabbed","../layout/Grid","./HipieDDL","../layout/Surface","../layout/Cell"],e):t.marshaller_Tabbed=e(t.d3,t.layout_Tabbed,t.layout_Grid,t.marshaller_HipieDDL,t.layout_Surface,t.layout_Cell)}(this,function(t,e,i,a,s,o){function r(){e.call(this)}function n(t,e){e instanceof Object||e&&(e=JSON.parse(e));var i=null,s={};return t.accept({visit:function(t){t instanceof a.Dashboard?(i={dashboard:t,visualizations:[]},s[t.getQualifiedID()]=i):t instanceof a.DataSource?t.databomb&&e[t.id]&&t.comms.databomb(e[t.id]):t instanceof a.Output?t.dataSource.databomb&&t.dataSource.comms.databombOutput(t.from):t instanceof a.Visualization&&t.widget&&i.visualizations.push(t)}}),s}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype._class+=" marshaller_Tabbed",r.prototype.publish("ddlUrl","","string","DDL URL",null,{tags:["Private"]}),r.prototype.publish("databomb","","string","Data Bomb",null,{tags:["Private"]}),r.prototype.publish("proxyMappings",{},"object","Proxy Mappings",null,{tags:["Private"]}),r.prototype.publish("designMode",!1,"boolean","Design Mode",null,{tags:["Basic"]}),r.prototype.testData2=function(){return this.ddlUrl("http://10.241.100.159:8002/WsEcl/submit/query/roxie/hipie_testrelavator3.ins002_service/json"),this},r.prototype._origDesignMode=r.prototype.designMode,r.prototype.designMode=function(t){var e=r.prototype._origDesignMode.apply(this,arguments);return arguments.length&&this.widgets().forEach(function(e){e.widget().designMode(t)}),e},r.prototype.render=function(s){function o(){var t=n(u.marshaller,u.databomb());if(!r.length){u.marshaller.dashboardTotal<=1&&u.showTabs(!1);for(var a in t){var o=new i;u.addTab(o,t[a].dashboard.title);var p=0,h=0,l=Math.floor(Math.sqrt(t[a].visualizations.length));t[a].visualizations.forEach(function(t,e){e&&e%l===0&&(p++,h=0),t.widget.size({width:0,height:0}),o.setContent(p,h,t.widget,t.title),h++})}}for(var c in t)for(var d in t[c].dashboard.datasources)t[c].dashboard.datasources[d].fetchData({},!0);e.prototype.render.call(u,function(t){s&&s(t)})}if(""===this.ddlUrl()||this.ddlUrl()===this._prev_ddlUrl&&this.databomb()===this._prev_databomb)return e.prototype.render.apply(this,arguments);this._prev_ddlUrl&&this._prev_ddlUrl!==this.ddlUrl()&&this.clearTabs(),this._prev_ddlUrl=this.ddlUrl(),this._prev_databomb=this.databomb();var r=[];this.widgets().forEach(function(t){r=r.concat(t.widget().content())});var u=this;return this.marshaller=(new a.Marshaller).proxyMappings(this.proxyMappings()).widgetMappings(t.map(r.map(function(t){return t.widget()}),function(t){return t.id()})).on("commsError",function(t,e){u.commsError(t,e)}),"["===this.ddlUrl()[0]||"{"===this.ddlUrl()[0]?this.marshaller.parse(this.ddlUrl(),function(){o()}):this.marshaller.url(this.ddlUrl(),function(){o()}),this},r.prototype.commsError=function(t,e){alert("Comms Error:\n"+t+"\n"+e)},r}),define("hpcc-viz-marshaller",function(){});