(function(e,t){typeof define=="function"&&define.amd?define(["d3","../common/HTMLWidget","./Paginator","../common/Utility","css!./Table"],t):e.other_Table=t(e.d3,e.common_HTMLWidget,e.other_Paginator,e.common_Utility)})(this,function(e,t,n,r){function i(){t.call(this),this._tag="div",this._currentSort="",this._currentSortOrder=1,this.columns([]),this._paginator=new n,this._selectionBag=new r.Selection,this._selectionPrevClick=null,this._paginatorTableSpacing=4}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype._class+=" other_Table",i.prototype.publish("renderHtmlDataCells",!1,"boolean","enable or disable HTML within cells",null,{tags:["Private"]}),i.prototype.publish("pagination",!1,"boolean","Enable or disable pagination",null,{tags:["Private"]}),i.prototype.publish("paginationLimit",null,"number","Maximum number of rows allowed before pagination defaults to on",null,{tags:["Private"]}),i.prototype.publishProxy("itemsPerPage","_paginator"),i.prototype.publishProxy("pageNumber","_paginator","pageNumber",1),i.prototype.publishProxy("adjacentPages","_paginator"),i.prototype.publish("showHeader",!0,"boolean","Show or hide the table header",null,{tags:["Private"]}),i.prototype.publish("fixedHeader",!0,"boolean","Enable or disable fixed table header",null,{tags:["Private"]}),i.prototype.publish("fixedColumn",!1,"boolean","Enable or disable fixed first column",null,{tags:["Private"]}),i.prototype.publish("fixedSize",!1,"boolean","Fix Size to Min Width/Height"),i.prototype.publish("theadFontSize",null,"string","Table head font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontSize",null,"string","Table body font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontSize",null,"string","Table body font size",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadFontColor",null,"html-color","Table head font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontColor",null,"html-color","Table body font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontColor",null,"html-color","Table body font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadFontFamily",null,"string","Table head font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFontFamily",null,"string","Table body font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootFontFamily",null,"string","Table body font family",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadCellBorderColor",null,"html-color","Table head cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootCellBorderColor",null,"html-color","Table head cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("theadRowBackgroundColor",null,"html-color","Table head row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tfootRowBackgroundColor",null,"html-color","Table head row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyCellBorderColor",null,"html-color","Table body cell border color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyRowBackgroundColor",null,"html-color","Table body row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFirstColFontColor",null,"html-color","Table body first column font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyFirstColBackgroundColor",null,"html-color","Table body first column background color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyHoverRowFontColor",null,"html-color","Table body hover row font color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodyHoverRowBackgroundColor",null,"html-color","Table body hover row background color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodySelectedRowFontColor",null,"html-color","Table body selected row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tbodySelectedRowBackgroundColor",null,"html-color","Table body selected row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("tableZebraColor",null,"html-color","Table zebra row color",null,{tags:["Basic"],optional:!0}),i.prototype.publish("totalledColumns",[],"array","Array of indices of the columns to be totalled",null,{tags:["Basic"],optional:!0}),i.prototype.publish("totalledLabel",null,"string","Adds a label to the first column of the 'Totalled' row",null,{tags:["Basic"],optional:!0}),i.prototype.publish("columnPatterns",[],"array","Array of formatting rules for each column",null,{tags:["Basic"],optional:!0}),i.prototype.publish("stringAlign","left","set","Array of alignment positions for strings",["left","right","center"],{tags:["Basic"],optional:!0}),i.prototype.publish("numberAlign","right","set","Array of alignment positions for numbers",["left","right","center"],{tags:["Basic"],optional:!0}),i.prototype.data=function(e){var n=t.prototype.data.apply(this,arguments);return arguments.length&&(this._currentSort="",this._currentSortOrder=1),n},i.prototype.size=function(e){var n=t.prototype.size.apply(this,arguments);if(arguments.length&&this.tableDiv){var r=this.showHeader()&&this.fixedHeader()?this.thead.node().offsetHeight:0;this.tableDiv.style("width",this._size.width+"px").style("height",this._size.height-r+"px"),this._element.style("width",this._size.width+"px").style("height",this._size.height+"px")}return n},i.prototype.enter=function(e,n){t.prototype.enter.apply(this,arguments),this._parentElement.style("overflow","hidden"),this.tableDiv=n.append("div").attr("class","tableDiv"),this.table=this.tableDiv.append("table"),this.fixedHead=this._element.append("div").classed("header-wrapper",!0),this.fixedHeadTable=this.fixedHead.append("table"),this.fixedThead=this.fixedHeadTable.append("thead").append("tr"),this.unfixedThead=this.table.append("thead").append("tr"),this.tbody=this.table.append("tbody"),this.tfoot=this.table.append("tfoot").append("tr"),this.fixedCol=this._element.append("div").classed("rows-wrapper",!0),this.fixedColTable=this.fixedCol.append("table"),this.fixedColHead=this.fixedColTable.append("thead"),this.fixedColHeadRow=this.fixedColHead.append("tr"),this.fixedColBody=this.fixedColTable.append("tbody"),this.fixedColFoot=this.fixedColTable.append("tfoot"),this.fixedColFootRow=this.fixedColFoot.append("tr"),this.tableDiv.style("overflow","auto")},i.prototype.update=function(n,r){function D(){var e=A.width-parseInt(T);_=i.table.node().offsetWidth-T+i.getScrollbarWidth(),M=e>_?_:e,M+="px"}function P(){O=A.height-w+i.getScrollbarWidth(),O+="px"}t.prototype.update.apply(this,arguments);var i=this;this.fixedHeader()?this.thead=this.fixedThead:this.thead=this.unfixedThead,this.fixedHead.style("display",this.fixedHeader()?"table-row":"none"),this.unfixedThead.style("display",this.fixedHeader()?"none":"table-row");var s=this.thead.selectAll("th").data(this.showHeader()?this.columns():[],function(e){return e});s.enter().append("th").each(function(t){var n=e.select(this);n.append("span").attr("class","thText"),n.append("span").attr("class","thIcon")}).on("click",function(e,t){i.headerClick(e,t)}),s.style("background-color",this.theadRowBackgroundColor()).style("border-color",this.theadCellBorderColor()).style("color",this.theadFontColor()).style("font-size",this.theadFontSize()),s.select(".thText").style("font-family",this.theadFontFamily()).text(function(e){return e}),s.select(".thIcon").text(function(e,t){return i._currentSortOrder===-1?i._currentSort===t?"":"":i._currentSort===t?"":""}),s.exit().remove(),s.order(),this.paginationLimit()&&this.pagination(this.data().length>=parseInt(this.paginationLimit())?!0:!1);if(this.pagination()){this._paginator.target()===null&&this._paginator.target(r.node());var o=this._calcRowsPerPage(s);this.itemsPerPage(o),this._paginator.numItems(this.data().length),this._tNumPages=Math.ceil(this._paginator.numItems()/this.itemsPerPage())||1,(this.pageNumber()>this._tNumPages||this.pageNumber()<=0)&&this.pageNumber(1),this._paginator._onSelect=function(e,t){i.pageNumber(e),i.render();return},this.tableDiv.style("overflow-y","hidden")}else this.tableDiv.style("overflow-y",null),this._paginator.numItems(0);var u=this.pageNumber()-1,a=this.itemsPerPage(),f=u*a,l=parseInt(u*a)+parseInt(a),c=null;this.pagination()?c=this.data().slice(f,l):c=this.data();var h=[this.totalledLabel()?this.totalledLabel():null];if(i.totalledColumns().length!==0){for(var p=0;p<i.totalledColumns().length;p++)i.totalledColumns()[p]=+i.totalledColumns()[p];for(var d=1;d<i.columns().length;d++){var v=0;if(i.totalledColumns().indexOf(d)!==-1){for(var m=0;m<c.length;m++)v+=c[m][d];h.push(v)}else h.push("")}var g=this.tfoot.selectAll("td").data(h);g.enter().append("td"),g[this.renderHtmlDataCells()?"html":"text"](function(e,t){var n=i.columnPatterns()[t]?i.getColumnFormatting(e,t):e;return n}),g.exit().remove(),g.style("background-color",this.tfootRowBackgroundColor()).style("border-color",this.tfootCellBorderColor()).style("color",this.tfootFontColor()).style("font-size",this.tfootFontSize())}var y=this.tbody.selectAll("tr").data(c);y.enter().append("tr").on("click.selectionBag",function(e,t){i.selectionBagClick(e),i.render(),i.applyRowStyles(i.getBodyRow(t)),i.applyFirstColRowStyles(i.getFixedRow(t))}).on("click",function(t){i.click(i.rowToObj(t),null,i._selectionBag.isSelected(i._createSelectionObject(t))),i.applyRowStyles(e.select(this))}).on("mouseover",function(e,t){var n=i.getFixedRow(t);if(n.empty())return;n.classed("hover",!0);var r=i.getBodyRow(t);r.classed("hover",!0),r.classed("selected")&&n.classed("selected",!0),i.applyStyleToRows(r),i.applyFirstColRowStyles(n)}).on("mouseout",function(e,t){var n=i.getFixedRow(t);n.classed("hover",!1);var r=i.getBodyRow(t);r.classed("hover",!1),i.applyStyleToRows(r),i.applyFirstColRowStyles(n)}),y.attr("class",function(e){if(i._selectionBag.isSelected(i._createSelectionObject(e)))return"selected"}),y.exit().remove();var b=y.selectAll("td").data(function(e,t){return e});b.enter().append("td"),b[this.renderHtmlDataCells()?"html":"text"](function(e,t){var n=i.columnPatterns()[t]?i.getColumnFormatting(e,t):e;return n}),b.exit().remove(),y.each(function(t,n){e.select(this).selectAll("td").each(function(t,r){var s=i.getColumnAlignment(t);e.select(this).classed("tr-"+n+"-td-"+r,!0).style("text-align",s)});var r=e.select(this);i.applyStyleToRows(r)});var w=this.thead.node().offsetHeight,E=i.table.select("tbody tr"),S=E.selectAll("td"),x=0;this.fixedHeader()&&s.each(function(e,t){var n=this.offsetWidth,r=S.length?S[0][t].offsetWidth:0,i=n>=r?n:r;this.style.width=i+"px",S.length&&(S[0][t].style.width=i+"px"),x+=i}),this.size(this._size),this.thead.style("position",this.fixedHeader()?"absolute":"relative").style("width",x+"px"),this.table.style("width",x+"px"),this.tbody.style("width",x+"px");var T=0,N=this.fixedColHeadRow.selectAll("th").data(this.fixedColumn()&&this.showHeader()?[this.columns()[0]]:[]);N.enter().append("th").each(function(t){var n=e.select(this);n.append("span").attr("class","thText"),n.append("span").attr("class","thIcon")}).on("click",function(e,t){i.headerClick(e,t)}),N.style("background-color",this.theadRowBackgroundColor()).style("border-color",this.theadCellBorderColor()).style("color",this.theadFontColor()).style("font-size",this.theadFontSize()),N.select(".thText").style("font-family",this.theadFontFamily()).text(function(e){return e}),N.select(".thIcon").text(function(e,t){return i._currentSortOrder===-1?i._currentSort===t?"":"":i._currentSort===t?"":""}),N.exit().remove();var C=this.fixedColBody.selectAll("tr").data(this.fixedColumn()?c:[]);C.enter().append("tr"),C.classed("selected",function(e){return i._selectionBag.isSelected(i._createSelectionObject(e))}).on("click",function(t,n){e.select(y[0][n]).on("click.selectionBag")(y.data()[n],n)}).on("mouseover",function(t,n){e.select(y[0][n]).on("mouseover")(y.data()[n],n)}).on("mouseout",function(t,n){e.select(y[0][n]).on("mouseout")(y.data()[n],n)}),C.exit().remove();var k=C.selectAll("td").data(function(e,t){return[e[0]]});k.enter().append("td"),k[this.renderHtmlDataCells()?"html":"text"](function(e){return typeof e=="string"?e.trim():typeof e=="number"?e:""}),k.exit().remove();var L=this.fixedColFootRow.selectAll("td").data(this.fixedColumn()&&this.totalledLabel()?[this.totalledLabel()]:[]);L.enter().append("td"),L[this.renderHtmlDataCells()?"html":"text"](function(e){return typeof e=="string"?e.trim():typeof e=="number"?e:""}),L.exit().remove(),this.fixedColumn()&&(this.showHeader()?T=k.node().offsetWidth>N.node().offsetWidth?k.node().offsetWidth:N.node().offsetWidth:T=k.node().offsetWidth,this.fixedCol.style("position","absolute").style("margin-top",-this.tableDiv.node().scrollTop+w+"px"),k.style("width",T+"px"),this.fixedColHead.style("position","absolute").style("margin-top",(this.fixedHeader()?this.tableDiv.node().scrollTop:0)-w+"px"),N.style("width",T+"px")),this.table.style("margin-left",-T+"px"),this.tableDiv.style("margin-left",T+"px").style("margin-top",(this.fixedHeader()?w:0)+"px").style("width",this.width()-T+"px"),this._paginator.render(),i.applyStyleToRows(this.tbody.selectAll("tr")),this._paginator.right((this.hasVScroll(this.tableDiv)?this.getScrollbarWidth():0)+this._paginatorTableSpacing).bottom((this.hasHScroll(this.tableDiv)?this.getScrollbarWidth():0)+this._paginatorTableSpacing).render();if(this.fixedSize()){var A=e.select(".tableDiv > table").node().getBoundingClientRect(),O,M,_;A.width!==0&&A.height!==0?(D(),P()):(A.height-w<=i.tableDiv.node().offsetHeight?P():i.fixedHeader()?(O=i.node().offsetHeight,O+="px"):O="100%",A.width-parseInt(T)<i.tableDiv.node().offsetWidth?D():i.fixedColumn()?(M=i.node().offsetWidth-parseInt(T),M+="px"):M="100%"),i.tableDiv.style("width",M).style("height",O)}this.setOnScrollEvents(this.tableDiv.node(),w)},i.prototype.exit=function(e,n){this._paginator.target(null),t.prototype.exit.apply(this,arguments)},i.prototype.getBodyRow=function(e){return this.table.selectAll("tbody tr").filter(function(t,n){return n===e})},i.prototype.getFixedRow=function(e){return this._element.selectAll(".rows-wrapper tbody tr").filter(function(t,n){return n===e})},i.prototype.setOnScrollEvents=function(e,t){var n=this;e.onscroll=function(e){var r=e.target.scrollTop,i=e.target.scrollLeft;n.fixedHeader()&&n.thead.style("margin-left",-i+"px"),n.fixedColumn()&&(n.fixedCol.style("margin-top",-r+parseInt(t)+"px"),n.fixedHeader()&&n.fixedColHead.style("margin-top",r-parseInt(t)+"px"))}},i.prototype._generateTempRow=function(){var e=this.tbody.append("tr");return e.append("td").text("QQQ"),e},i.prototype._createSelectionObject=function(e){var t=this;return{_id:e,element:function(){return t.tbody.selectAll("tr").filter(function(t){return t===e})}}},i.prototype._calcRowsPerPage=function(e){this._paginator.numItems()===0&&(this._paginator.numItems(1),this.itemsPerPage(1)),this._paginator.render();var t=this.thead.selectAll("th").node()?this.thead.selectAll("th").node().clientHeight:0,n=this.tfoot.selectAll("td").node()?this.tfoot.selectAll("td").node().clientHeight:0,r=this._generateTempRow(),i=r.node().clientHeight;r.remove();var s=this.calcHeight(this._paginator.element()),o=Math.floor((this.height()-t-n-s-(this.hasHScroll(this.tableDiv)?this.getScrollbarWidth():0)-this._paginatorTableSpacing*2)/i)||1;return o},i.prototype.sort=function(e){this._currentSort!==e?(this._currentSort=e,this._currentSortOrder=1):this._currentSortOrder*=-1;var t=this;return this.data().sort(function(n,r){return n[e]===r[e]?0:typeof r[e]=="undefined"||n[e]>r[e]?t._currentSortOrder:t._currentSortOrder*-1}),this},i.prototype.headerClick=function(e,t){this.sort(t).render()},i.prototype.selection=function(e){return arguments.length?(this._selectionBag.set(e.map(function(e){return this._createSelectionObject(e)},this)),this):this._selectionBag.get().map(function(e){return e._id})},i.prototype.selectionBagClick=function(t){if(e.event.shiftKey&&this._selectionPrevClick){var n=!1,r=[],i=this.data().filter(function(e,i){var s=!1;if(e===t||e===this._selectionPrevClick)n&&(s=!0),n=!n,r.push(i);return n||s},this);return this.selection(i),r}this._selectionBag.isSelected(this._createSelectionObject(t))?(this._selectionBag.clear(),this._selectionPrevClick=null):(this._selectionBag.click(this._createSelectionObject(t),e.event),this._selectionPrevClick=t)},i.prototype.applyHoverRowStyles=function(e){var t=this;e.style("color",t.tbodyHoverRowFontColor()).style("background-color",t.tbodyHoverRowBackgroundColor())},i.prototype.applySelectedRowStyles=function(e){var t=this;e.style("color",t.tbodySelectedRowFontColor()).style("background-color",t.tbodySelectedRowBackgroundColor())},i.prototype.applyRowStyles=function(e,t){e.style("color",t?this.tbodyFirstColFontColor():this.tbodyFontColor()).style("background-color",t?this.tbodyFirstColBackgroundColor():this.tableZebraColor_exists()&&this.data().indexOf(e.datum())%2?this.tbodyRowBackgroundColor():this.tableZebraColor())},i.prototype.applyFirstColRowStyles=function(e){this.applyStyleToRows(e,!0)},i.prototype.applyStyleToRows=function(t,n){n=typeof n!="undefined"?n:!1;var r=this;t.each(function(){var t=e.select(this);t.classed("hover")?r.applyHoverRowStyles(t):t.classed("selected")?r.applySelectedRowStyles(t):r.applyRowStyles(t,n)})},i.prototype.getColumnFormatting=function(t,n){var r=this;if(typeof t=="string"){var i=e.time.format(r.columnPatterns()[n]);return i(new Date(t))}if(typeof t=="number"){var s=e.format(r.columnPatterns()[n]);return s(t)}return t},i.prototype.getColumnAlignment=function(e){var t=this;switch(typeof e){case"number":return function(){return t.numberAlign()};case"string":return function(){return t.stringAlign()};default:return""}},i.prototype.click=function(e,t){console.log("Click:  "+JSON.stringify(e)+", "+t)},i.prototype.headerClick=function(e,t){this.sort(t).render()},i});